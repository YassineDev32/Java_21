---
- name: Deploy Docker container on app server
  hosts: app
  become: yes
  vars:
    nexus_url: "164.92.169.9:5000"
    nexus_repo: "docker-local"
    image_name: "myapp"
    container_name: "myapp-container"
  tasks:
    - name: Log in to Nexus Docker registry
      docker_login:
        registry_url: "{{ nexus_url }}"
        username: "{{ lookup('env','NEXUS_USER') }}"
        password: "{{ lookup('env','NEXUS_PASS') }}"

    - name: Pull latest Docker image
      docker_image:
        name: "{{ nexus_url }}/{{ nexus_repo }}/{{ image_name }}"
        tag: latest
        source: pull

    - name: Stop existing container
      docker_container:
        name: "{{ container_name }}"
        state: stopped
      ignore_errors: yes

    - name: Remove existing container
      docker_container:
        name: "{{ container_name }}"
        state: absent
      ignore_errors: yes

    - name: Run new container
      docker_container:
        name: "{{ container_name }}"
        image: "{{ nexus_url }}/{{ nexus_repo }}/{{ image_name }}:latest"
        state: started
        restart_policy: unless-stopped
        ports:
          - "8080:8080"   # adjust to your app port
